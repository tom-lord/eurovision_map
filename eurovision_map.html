<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <title>JQVMap - Europevision Map</title>
    
    <link href="./jqvmap/jqvmap.css" media="screen" rel="stylesheet" type="text/css" />
    
    <script src="./jqvmap/jquery.min.js" type="text/javascript"></script>
    <script src="./jqvmap/jquery.vmap.js" type="text/javascript"></script>
    <script src="./jqvmap/maps/jquery.vmap.europe.js" type="text/javascript"></script>
    <script src="./data/colour_schemes/gold_silver_bronze_green_to_red.js" type="text/javascript"></script>
    <script src="./data/results/2014/from_country_rank.js" type="text/javascript"></script>
    <script src="./data/country_lists/2014_contestants.js" type="text/javascript"></script>
    <script src="./lib/voting_systems.js" type="text/javascript"></script>
    
    <script type="text/javascript">
    jQuery(document).ready(function() {
        // Helper functions
        function set_colour_scheme(new_colour_scheme)
        {
            jQuery('#vmap').vectorMap('set', 'colors', new_colour_scheme);
        }

        function rankings_for_country(code)
        {
            //TODO: One day, this will be a configurable lookup
            // e.g. Use 2013 data, or switch to "votes FOR country" mode
            return from_country_2014_rank[code.toUpperCase()];
        }

        function verbose_label(label, code)
        {
            var new_label = label[0].textContent + "<br />"; // Get country name
            if( country_entered(code) )
            {
                new_label += "Position: " + country_position(code) + "/" + countries_entered()
                    + "<br />Total Score: " + country_score(code);
            }
            else if( country_voted_only(code) )
            {
                new_label += "(Voted but did<br />not compete)"
            }
            else
            {
                new_label += "(Did not compete)"
            }
            return new_label;
        }

        function country_score(to_country)
        {
            var score = 0;
            for(var from_country in from_country_2014_rank) //TODO: One day, this will be configurable
            {
                if( from_country != to_country.toUpperCase())
                {
                    score += (voting_system_1975_to_present[ from_country_2014_rank[from_country][to_country] - 1 ] || 0);
                }
            }
            return score;
        }

        function get_colour_scheme(rankings)
        {
            //TODO: One day, colour_scheme will be configurable
            // e.g. "Gold/Silver/Bronze only", or "Full green-->red"
            var new_colour_scheme = {};
            jQuery.each(rankings, function(idx){ 
                new_colour_scheme[idx] = colour_scheme[this];
            })
            return new_colour_scheme;
        }

        function country_entered(code)
        {
            //TODO: One day, year will be configurable
            return jQuery.inArray(code.toUpperCase(), contestants_entered_2014) != -1
        }

        function country_voted_only(code)
        {
            //TODO: One day, year will be configurable
            return jQuery.inArray(code.toUpperCase(), contestants_voted_only_2014) != -1
        }

        function country_position(code)
        {
            // This is really inefficient, but means I can be lazy in entering data
            var position = 1;
            var is_joint_position = false;
            my_score = country_score(code);
            //TODO: One day, year will be configurable
            jQuery.each(contestants_entered_2014, function(idx) 
            {
                contestant = this.toLowerCase();
                if( contestant != code )
                {
                   var their_score = country_score(contestant);
                   if( their_score > my_score )
                    {
                        position += 1;
                    }
                    else if( their_score == my_score )
                    {
                        is_joint_position = true;
                    }
                }
            })
            if(is_joint_position)
            {
                position = "==" + position;
            }
            return position;
        }

        function countries_entered()
        {
            //TODO: One day, year will be configurable
            return contestants_entered_2014.length;
        }


        // Main code
        jQuery('#vmap').vectorMap({
            map: 'europe_en',
            enableZoom: false,
            showTooltip: true,
            selectedRegion: 'GB',
            onLabelShow: function(element, label, code)
            {
                label.html(verbose_label(label, code));
            },
            onRegionClick: function(event, code, region)
            {
                var rankings = rankings_for_country(code);
                var new_colour_scheme = get_colour_scheme(rankings);

                set_colour_scheme(new_colour_scheme);
            }
        });
    });
    </script>
  </head>
  <body>
    <div id="vmap" style="width: 680px; height: 520px;"></div>
  </body>
</html>
